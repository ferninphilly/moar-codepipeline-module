version: 0.2

env:
  shell: bash
  secrets-manager:
    NPM_AUTH_TOKEN: "npmjs/publish/authToken"
phases:
  install:
    commands:
      - yarn install --frozen-lockfile --offline --check-files --cache-folder ./cache
  pre_build:
    commands:
      - echo "//registry.npmjs.org/:_authToken=$NPM_AUTH_TOKEN" > ./.npmrc
      - export LATEST_VERSION=`yarn --json info @codices-io/moar-${CLIENT} | jq '.data."dist-tags".latest' | sed -e 's/"//g'`
      - cat package.json | jq ".version = \"$LATEST_VERSION\"" > package-new.json
      - rm package.json && mv package-new.json package.json
  build:
    commands:
      - yarn publish --non-interactive --patch --no-git-tag-version
